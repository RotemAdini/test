<!DOCTYPE html>

<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>×œ×•×— × ×™×”×•×œ ×¢×¨×™×›×ª ×¡×¨×˜×•× ×™×</title>
<style>
:root{--bg:#efe7ff;--card:#fff;--ink:#1b1033;--muted:#6a5d8f;--purple:#7b5cff;--purple-2:#5b3df7;--line:#ded3ff;--red:#ff4d4f;--yellow:#fdbc3d;--green:#31c655}
*{box-sizing:border-box}html,body{height:100%;margin:0}
body{background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,sans-serif}
.wrap{max-width:1100px;margin:0 auto;padding:24px}
header{display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.title{font-size:clamp(20px,2.6vw,28px);font-weight:800}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
button,.btn{border:0;background:var(--purple);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;box-shadow:0 2px 0 rgba(0,0,0,.08)}
button:hover{background:var(--purple-2)}
.btn-outline{background:transparent;color:var(--purple);border:2px solid var(--purple);box-shadow:none}
.btn-ghost{background:transparent;color:var(--muted)}
.btn-danger{background:var(--red)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
.controls-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
input[type="text"],input[type="date"],select,textarea{padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;color:var(--ink)}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-weight:600}
.dot{width:10px;height:10px;border-radius:50%}.dot.red{background:var(--red)}.dot.yellow{background:var(--yellow)}.dot.green{background:var(--green)}
.filters-panel{display:none;gap:6px;align-items:center}
.filters-panel.open{display:flex}

.board{display:flex;flex-direction:column;gap:10px}
.col{background:var(â€“card);border:1px solid var(â€“line);border-radius:14px;overflow:hidden}
.col-header{display:flex;align-items:center;gap:10px;padding:12px 14px;background:#f6f2ff;border-bottom:1px solid var(â€“line);user-select:none;position:relative}
.col-title{display:flex;gap:8px;align-items:center;cursor:pointer}
.col-header h3{margin:0;font-size:16px}
.count{margin-inline-start:auto;color:var(â€“muted);font-weight:700;font-size:12px}
.header-actions{display:flex;gap:6px}
.col .rename-btn{background:transparent;color:var(â€“muted)}
.chev{transition:transform .2s}
.col.collapsed .chev{transform:rotate(180deg)}
.col-header.drop-hover{outline:2px dashed var(â€“purple)}
.list{display:grid;gap:8px;padding:12px;min-height:40px}
.col.collapsed .list{display:none}

/* ×¡×’× ×•×Ÿ ××™×•×—×“ ×œ×§×˜×’×•×¨×™×™×ª ×”××©×™××•×ª */
.tasks-section{background:linear-gradient(135deg,#fff5e6 0%,#ffe8f5 100%);border:2px solid #ffd4e5}
.tasks-section .col-header{background:linear-gradient(135deg,#fff9f0 0%,#fff0f8 100%)}

.item{background:#fff;border:1px solid var(â€“line);border-radius:12px;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 2px 0 rgba(0,0,0,.04);position:relative}
.item[draggable=â€œtrueâ€]{cursor:grab}.item.dragging{opacity:.6;cursor:grabbing}
.item.drag-over-top::before{content:â€™â€™;position:absolute;top:-4px;left:0;right:0;height:3px;background:var(â€“purple);border-radius:2px}
.item.drag-over-bottom::after{content:â€™â€™;position:absolute;bottom:-4px;left:0;right:0;height:3px;background:var(â€“purple);border-radius:2px}

/* ×¡×’× ×•×Ÿ ×¤×¨×™×˜×™ ××©×™××•×ª */
.task-item{background:linear-gradient(135deg,#fffcf7 0%,#fff8fd 100%);border:1px solid #ffe8f0;transition:all 0.3s ease}
.task-item.completed{opacity:0.6;background:#f5f5f5}
.task-item.completed .task-text{text-decoration:line-through;color:var(â€“muted)}
.task-checkbox{width:24px;height:24px;cursor:pointer;accent-color:var(â€“purple);flex-shrink:0}
.task-text{flex:1;min-width:0}
.task-actions{display:flex;gap:4px;opacity:0.7}
.task-item:hover .task-actions{opacity:1}

.badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:6px 10px;font-size:12px;font-weight:700;color:#222;background:#f8f8f8;border:1px solid var(â€“line)}
.badge.red{background:rgba(255,77,79,.14);border-color:#ffc7c8}
.badge.yellow{background:rgba(253,188,61,.18);border-color:#ffe3b0}
.badge.green{background:rgba(49,198,85,.16);border-color:#c7f0d4}
.grow{flex:1;min-width:120px}
.meta{color:var(â€“muted);font-size:12px}
.actions{display:flex;gap:6px}
.ghost{border:2px dashed var(â€“purple);background:#f6f2ff;border-radius:12px;height:42px;margin:0 12px 12px;display:none}
.col.dragover .ghost{display:block}
.muted{color:var(â€“muted)}.small{font-size:12px}

/* ××•×“××œ×™× */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:1000}
.modal{background:#fff;max-width:820px;width:100%;border-radius:12px;padding:16px;border:1px solid var(â€“line)}
.modal header{justify-content:space-between;margin:0 0 12px}
.modal textarea{width:100%;height:220px;font-family:monospace;direction:ltr}
.modal .help{background:#faf8ff;border:1px dashed var(â€“line);padding:10px;border-radius:10px;font-size:12px}
.editor .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.editor .label{font-weight:700;min-width:90px;align-self:center}
.editor .chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{border:1px solid var(â€“line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer;font-weight:700}
.chip.active{outline:2px solid var(â€“purple)}
.chip .dot{margin-inline-start:6px}
.modal footer{display:flex;gap:8px;justify-content:flex-end;padding-top:8px}

/* ×¤×•×¤××‘×¨ ××¢×‘×¨ ××”×™×¨ */
.quick-move{position:absolute;z-index:900;background:#fff;border:1px solid var(â€“line);border-radius:10px;padding:10px;box-shadow:0 6px 24px rgba(0,0,0,.15);display:none;min-width:230px}
.quick-move .title{font-weight:800;margin-bottom:8px}
.quick-move .row{display:flex;gap:6px}
.quick-move select{flex:1}

/* ××“ ×”×ª×§×“××•×ª */
.progress-wrap{background:#fff;border:1px solid var(â€“line);border-radius:12px;padding:10px;margin:6px 0 12px}
.progress-head{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:6px}
.progress-legend{display:flex;gap:10px;flex-wrap:wrap;font-size:12px;color:var(â€“muted)}
.bar{width:100%;height:14px;border-radius:999px;background:#f1ecff;overflow:hidden;border:1px solid var(â€“line)}
.bar-inner{height:100%;display:flex}
.seg{height:100%}
.seg.done{background:var(â€“green)}
.seg.red{background:rgba(255,77,79,.5)}
.seg.yellow{background:rgba(253,188,61,.6)}
.seg.green{background:rgba(49,198,85,.5)}

footer.page-footer{display:flex;justify-content:flex-end;gap:8px;margin:18px 0 6px}

@media(max-width:700px){
.controls{flex-direction:column;align-items:stretch}
.wrap{padding:16px}
}

#toggleAllBtn,
#toggleAllBtn:focus,
#toggleAllBtn:active {
background: transparent !important;
color: var(â€“muted) !important;
box-shadow: none !important;
outline: none !important;
}

.btn-ghost:active,
.btn-ghost:focus {
background: transparent !important;
box-shadow: none !important;
outline: none !important;
}
</style>

</head>
<body>
<div class="wrap">
  <header>
    <div class="title">×œ×•×— × ×™×”×•×œ ×¢×¨×™×›×ª ×¡×¨×˜×•× ×™× ğŸ¬</div>
    <div class="toolbar">
      <button id="addVideoBtn">×”×•×¡×£ ×¡×¨×˜×•×Ÿ ğŸ¬</button>
      <button id="addCategoryBtn" class="btn-outline">×”×•×¡×£ ×§×˜×’×•×¨×™×” â•</button>
      <button id="toggleAllBtn" class="btn-ghost small">×¤×ª×— ×”×›×•×œ</button>
    </div>
  </header>

  <!-- ××“ ×”×ª×§×“××•×ª -->

  <section id="progress" class="progress-wrap" aria-live="polite">
    <div class="progress-head">
      <div class="muted"><strong>××“ ×”×ª×§×“××•×ª ×›×œ×œ×™</strong></div>
      <div id="progressNumbers" class="muted small"></div>
    </div>
    <div class="bar"><div id="barInner" class="bar-inner"></div></div>
    <div id="progressLegend" class="progress-legend"></div>
  </section>

  <!-- ××¡× × ×™× ×§×•××¤×§×˜×™×™× -->

  <div class="controls">
    <div class="controls-row" style="flex:1">
      <input id="searchInput" type="text" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©× ×¡×¨×˜×•×Ÿ..." style="flex:1"/>
      <button id="toggleFilters" class="btn-ghost small" title="×”×¦×’/×”×¡×ª×¨ ××¡× × ×™×">××¡× × ×™× â–¾</button>
    </div>
    <div id="filtersPanel" class="filters-panel">
      <label class="pill"><span class="dot red"></span><input type="checkbox" id="filterRed"/> ×“×—×•×£</label>
      <label class="pill"><span class="dot yellow"></span><input type="checkbox" id="filterYellow"/> ×‘×™× ×™×™×</label>
      <label class="pill"><span class="dot green"></span><input type="checkbox" id="filterGreen"/> ×™×© ×–××Ÿ</label>
      <div class="muted small">×˜×™×¤: ×’×¨×¨×™ ×¡×¨×˜×•×Ÿ ×‘×™×Ÿ ×§×˜×’×•×¨×™×•×ª ××• ×‘×ª×•×š ×”×§×˜×’×•×¨×™×” ×œ×¡×™×“×•×¨ ××—×“×©. ×œ×—×™×¦×” ××¨×•×›×” ×¢×œ ×¤×¨×™×˜ â†’ ××¢×‘×¨ ××”×™×¨ ×‘×™×Ÿ ×§×˜×’×•×¨×™×•×ª.</div>
    </div>
  </div>

  <!-- ×§×˜×’×•×¨×™×™×ª ××©×™××•×ª -->

  <section id="tasksSection" class="col tasks-section" style="margin-bottom:16px">
    <div class="col-header" id="tasksHeader">
      <div class="col-title">
        <span class="chev">â–¾</span>
        <h3>âœ… ××©×™××•×ª (×¦'×§-×œ×™×¡×˜)</h3>
      </div>
      <span id="tasksCount" class="count">0 ××©×™××•×ª</span>
      <div class="header-actions">
        <button id="addTaskBtn" class="btn-ghost small" title="×”×•×¡×£ ××©×™××”">â•</button>
      </div>
    </div>
    <div id="tasksList" class="list"></div>
  </section>

  <div id="board" class="board"></div>

  <!-- ×›×¤×ª×•×¨×™ ×™×™×‘×•×/×™×™×¦×•× ×œ×ª×—×ª×™×ª -->

  <footer class="page-footer">
    <button id="exportBtn" class="btn-ghost small">×™×™×¦×•×</button>
    <button id="importBtn" class="btn-ghost small">×™×™×‘×•×</button>
  </footer>
</div>

<!-- ××•×“××œ ×™×™×‘×•× -->

<div id="importModal" class="modal-backdrop">
  <div class="modal">
    <header><div class="title">×™×™×‘×•× ×¨×©×™××ª ×¡×¨×˜×•× ×™×</div><button id="closeImport" class="btn-ghost">âœ–</button></header>
    <div class="help">×”×“×‘×™×§×™ ×›××Ÿ JSON ×‘××—×ª ××”×¦×•×¨×•×ª:<ol><li><b>Board ××œ×</b> ×¢× <code>categories</code> ×•-<code>items</code>.</li><li><b>××¤×” ×§×¦×¨×”</b> ×©×œ ×§×˜×’×•×¨×™×” â†’ ××¢×¨×š ×¤×¨×™×˜×™×.</li></ol></div>
    <textarea id="importTextarea" placeholder='{"×¨×¢×™×•× ×•×ª":[{"title":"×©×","priority":"red"}]}'></textarea>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px"><button id="applyImport" class="btn">×™×™×‘×•×</button></div>
  </div>
</div>

<!-- ××•×“××œ ×¢×¨×™×›×ª ×¤×¨×™×˜ -->

<div id="editModal" class="modal-backdrop">
  <div class="modal editor">
    <header><div class="title">×¢×¨×™×›×ª ×¤×¨×™×˜</div><button id="closeEdit" class="btn-ghost">âœ–</button></header>
    <div class="row"><div class="label">×©× ×”××©×™××”</div><input id="editTitleInput" type="text" placeholder="×©× ×”×¤×¨×™×˜"></div>
    <div class="row"><div class="label">×“×—×™×¤×•×ª</div><div class="chips">
      <button class="chip" data-pr="red"><span class="dot red"></span>×“×—×•×£</button>
      <button class="chip" data-pr="yellow"><span class="dot yellow"></span>×‘×™× ×™×™×</button>
      <button class="chip" data-pr="green"><span class="dot green"></span>×™×© ×–××Ÿ</button>
    </div></div>
    <div class="row"><div class="label">×ª××¨×™×š ×™×¢×“</div><input id="editDueInput" type="date"></div>
    <div class="row"><div class="label">×§×˜×’×•×¨×™×”</div><select id="editCategorySelect"></select></div>
    <footer><button id="deleteItemBtn" class="btn btn-danger">××—×§×™</button><span style="flex:1"></span><button id="saveItemBtn" class="btn">×©××™×¨×”</button></footer>
  </div>
</div>

<script>
/* ===== × ×ª×•× ×™× ×•×©××™×¨×” ===== */
const STORAGE_KEY="video-board-v4";
function uid(){return Math.random().toString(36).slice(2,9)}

const DEFAULT_BOARD={
  tasks:[],
  categories:[
    {id:uid(),title:"×¨×¢×™×•× ×•×ª",collapsed:false,items:[
      {id:uid(),title:"×” â€“ ×”×—×œ×§×” ×¢×œ ×”×§×¨×—",priority:"green",due:""},
      {id:uid(),title:"×˜ â€“ ×˜× ×™×¡",priority:"green",due:""},
      {id:uid(),title:"×™ â€“ ×¡×™×•×¨ ×˜×¢×™××•×ª ×™×™×Ÿ (×™×§×‘ ×©×•×¨×¨)",priority:"green",due:""},
      {id:uid(),title:"×› â€“ ×“×™×™×˜ ×›×•×›×‘×™×",priority:"green",due:""},
      {id:uid(),title:"×œ â€“ ×œ×’×• / ××¡×¢×“×” ×©×•×•×”",priority:"green",due:""},
      {id:uid(),title:"× â€“ ××©×—×§×™ ×§×•×¤×¡× ×‘×‘×™×ª",priority:"green",due:""},
      {id:uid(),title:"×  â€“ ×”×›× ×ª ×•×¦×‘×™×¢×ª × ×¨×•×ª",priority:"green",due:""},
      {id:uid(),title:"×¡ â€“ ×¡×¤××¨×™ ×œ×™×œ×” / ×¡×˜× ×“ ××¤",priority:"green",due:""},
      {id:uid(),title:"×¢ â€“ ×¢×™×¡×•×™ ×–×•×’×™",priority:"green",due:""},
      {id:uid(),title:"×¤ â€“ ×¢×¨×‘ ×¤×™×¦×•×ª ×‘×¦×•×¨×ª ×œ×‘",priority:"green",due:""},
      {id:uid(),title:"×¦ â€“ ×¦×™×•×¨ ×¢×œ ×§× ×‘×¡ (××¤×©×¨ ×¦×™×•×¨×™ ××¦×‘×¢×•×ª)",priority:"green",due:""},
      {id:uid(),title:"×§ â€“ ×§×•×œ× ×•×¢ VIP",priority:"green",due:""},
      {id:uid(),title:"×¨ â€“ ×“×™×™×˜ ×¨×‘×™×¦×” ×‘×‘×™×ª (×¤×•×¤×™× ×•×©×˜×™×—×™×)",priority:"green",due:""},
      {id:uid(),title:"×© â€“ ×¡×“× ×ª ×©×•×§×•×œ×“",priority:"green",due:""},
      {id:uid(),title:"×ª â€“ ×œ×œ×›×ª ×œ×ª×™××˜×¨×•×Ÿ",priority:"green",due:""}
    ]},
    {id:uid(),title:"× ×§×‘×¢ ×ª××¨×™×š",collapsed:false,items:[
      {id:uid(),title:"× â€“ ×¡×“× ×ª ××•×›×œ ××™×˜×œ×§×™",priority:"green",due:""},
      {id:uid(),title:"×• â€“ ×•×™×–'×Ÿ ×‘×•×¨×“",priority:"green",due:""},
      {id:uid(),title:"×— â€“ ×“×™×™×˜ ×—×™××¨",priority:"green",due:""}
    ]},
    {id:uid(),title:"×¦×™×œ×× ×•",collapsed:false,items:[
      {id:uid(),title:"×‘ â€“ ×‘×™×¨×” ×¤×•× ×’",priority:"green",due:""},
      {id:uid(),title:"×“ â€“ ××¨×•×—×ª ×“×’×™×",priority:"green",due:""},
      {id:uid(),title:"×˜×¢×™××•×ª ×‘×¨××•× ×™×–",priority:"green",due:""},
      {id:uid(),title:"×©××œ×•×ª ×‘×¨××•× ×™×–",priority:"green",due:""}
    ]},
    {id:uid(),title:"×¢×¨×™×›×” ×‘×¡×™×¡×™×ª",collapsed:false,items:[
      {id:uid(),title:"×”×›× ×ª ×‘×¨××•× ×™×–",priority:"green",due:""},
      {id:uid(),title:"×’ â€“ ×“×™×™×˜ ×’×‘×™× ×•×ª ×—×œ×§ 1",priority:"green",due:""},
      {id:uid(),title:"×’ â€“ ×“×™×™×˜ ×’×‘×™× ×•×ª ×—×œ×§ 2 ×¤×™×§× ×™×§",priority:"green",due:""},
      {id:uid(),title:"×– â€“ ×“×™×™×˜ ×‘×–×¨×™×—×” (×˜×™×•×œ ×©×˜×— + ×–×¨×™×—×”)",priority:"green",due:""}
    ]},
    {id:uid(),title:"××•×›×Ÿ ×œ×¢×œ×™×™×”",collapsed:false,items:[
      {id:uid(),title:"×¤×•×‘: ×—×‘×¨ ×©×œ×š ×¨×¦×™× ×™ ×‘×¢×¨×‘×•×‘ ×’×‘×™× ×•×ª",priority:"green",due:""}
    ]},
    {id:uid(),title:"×¢×œ×”",collapsed:false,items:[]}
  ]
};

let board=loadBoard();

function saveBoard(){localStorage.setItem(STORAGE_KEY,JSON.stringify(board))}

function loadBoard(){
  try{
    const r=localStorage.getItem(STORAGE_KEY);
    if(!r)return structuredClone(DEFAULT_BOARD);
    const p=JSON.parse(r);
    if(!p.categories)p.categories=structuredClone(DEFAULT_BOARD.categories);
    if(!p.tasks)p.tasks=[];
    return p;
  }catch(e){
    return structuredClone(DEFAULT_BOARD);
  }
}

/* ===== ×¢×–×¨ ===== */
function escapeHTML(s){return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]))}
function debounce(f,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>f(...a),ms)}}
function normPriority(p){const m={"××“×•×":"red","×“×—×•×£":"red",red:"red","×¦×”×•×‘":"yellow","×‘×™× ×™×™×":"yellow",yellow:"yellow","×™×¨×•×§":"green","×™×© ×–××Ÿ":"green",green:"green"};return m[(p||"").toLowerCase()]||"green"}
function priorityLabel(p){return p==="red"?"×“×—×•×£":p==="yellow"?"×‘×™× ×™×™×":"×™×© ×–××Ÿ"}

/* ===== UI ===== */
const boardEl=document.getElementById("board");
const toggleAllBtn=document.getElementById("toggleAllBtn");
const tasksSection=document.getElementById("tasksSection");
const tasksHeader=document.getElementById("tasksHeader");
const tasksList=document.getElementById("tasksList");
const tasksCount=document.getElementById("tasksCount");

function render(){
  renderTasks();
  boardEl.innerHTML="";
  board.categories.forEach(c=>boardEl.appendChild(renderCategory(c)));
  attachDnD();
  updateToggleAllLabel();
  renderProgress();
}

/* ===== ××©×™××•×ª (×¦'×§-×œ×™×¡×˜) ===== */
function renderTasks(){
  tasksList.innerHTML="";
  tasksCount.textContent=`${board.tasks.length} ××©×™××•×ª`;
  
  board.tasks.forEach(task=>{
    const el=document.createElement("div");
    el.className="item task-item" + (task.completed?" completed":"");
    el.dataset.taskId=task.id;
    
    const checkbox=document.createElement("input");
    checkbox.type="checkbox";
    checkbox.className="task-checkbox";
    checkbox.checked=task.completed||false;
    checkbox.addEventListener("change",()=>{
      task.completed=checkbox.checked;
      saveBoard();
      renderTasks();
    });
    
    const text=document.createElement("div");
    text.className="task-text";
    text.innerHTML=`<strong>${escapeHTML(task.title)}</strong>`;
    
    const actions=document.createElement("div");
    actions.className="task-actions";
    
    const editBtn=document.createElement("button");
    editBtn.className="btn-ghost small";
    editBtn.textContent="âœï¸";
    editBtn.title="×¢×¨×™×›×”";
    editBtn.addEventListener("click",()=>editTask(task.id));
    
    const delBtn=document.createElement("button");
    delBtn.className="btn-ghost small";
    delBtn.textContent="ğŸ—‘ï¸";
    delBtn.title="××—×™×§×”";
    delBtn.addEventListener("click",()=>{
      if(confirm(`×œ××—×•×§ ××ª "${task.title}"?`)){
        board.tasks=board.tasks.filter(t=>t.id!==task.id);
        saveBoard();
        renderTasks();
      }
    });
    
    actions.append(editBtn,delBtn);
    el.append(checkbox,text,actions);
    tasksList.appendChild(el);
  });
}

function editTask(taskId){
  const task=board.tasks.find(t=>t.id===taskId);
  if(!task)return;
  
  const newTitle=prompt("×©× ×”××©×™××”:",task.title);
  if(newTitle===null)return;
  
  task.title=newTitle.trim()||task.title;
  saveBoard();
  renderTasks();
}

// ×”×•×¡×¤×ª ××©×™××” ×—×“×©×”
document.getElementById("addTaskBtn").addEventListener("click",()=>{
  const title=prompt("×©× ×”××©×™××”:");
  if(!title)return;
  
  board.tasks.push({
    id:uid(),
    title:title.trim(),
    completed:false
  });
  
  saveBoard();
  renderTasks();
});

// ×¤×ª×™×—×”/×¡×’×™×¨×” ×©×œ ×§×˜×’×•×¨×™×™×ª ×”××©×™××•×ª
tasksHeader.addEventListener("click",()=>{
  tasksSection.classList.toggle("collapsed");
});

/* ×§×˜×’×•×¨×™×” */
function renderCategory(cat){
  const col=document.createElement("section");
  col.className="col"+(cat.collapsed?" collapsed":""); 
  col.dataset.catId=cat.id;

  const header=document.createElement("div"); 
  header.className="col-header";

  const titleWrap=document.createElement("div"); 
  titleWrap.className="col-title";
  const chev=document.createElement("span"); 
  chev.className="chev"; 
  chev.textContent="â–¾";
  const h3=document.createElement("h3"); 
  h3.textContent=cat.title; 
  h3.title="×œ×—×¦×™ ×¤×¢××™×™× ×œ×©×™× ×•×™ ×©×";
  titleWrap.append(chev,h3);

  titleWrap.addEventListener("click",(e)=>{ 
    if(e.detail===1){ 
      cat.collapsed=!cat.collapsed; 
      saveBoard(); 
      render(); 
    }
  });
  h3.addEventListener("dblclick",(e)=>{ 
    e.stopPropagation(); 
    renameCategory(cat.id); 
  });

  const list=document.createElement("div"); 
  list.className="list";
  const f=currentFilters();
  const visibleItems = cat.items.filter(item=>passesFilters(item,f));
  const count=document.createElement("span"); 
  count.className="count";
  count.textContent=visibleItems.length+" ×¤×¨×™×˜×™×";

  const headerActions=document.createElement("div"); 
  headerActions.className="header-actions";
  const renameBtn=document.createElement("button");
  renameBtn.className="rename-btn btn-ghost small";
  renameBtn.textContent="âœï¸";
  renameBtn.title="×©×™× ×•×™ ×©× ×§×˜×’×•×¨×™×”";
  renameBtn.addEventListener("click",(e)=>{
    e.stopPropagation(); 
    renameCategory(cat.id);
  });
  headerActions.append(renameBtn);

  header.append(titleWrap,count,headerActions);

  visibleItems.forEach(item=>{ 
    list.appendChild(renderItem(item,cat.id)); 
  });

  const ghost=document.createElement("div"); 
  ghost.className="ghost";
  col.append(header,list,ghost);
  setupHeaderDrop(header,cat);
  return col;
}

function renameCategory(catId){
  const cat=board.categories.find(c=>c.id===catId); 
  if(!cat) return;
  const name=prompt("×©× ×—×“×© ×œ×§×˜×’×•×¨×™×”:",cat.title);
  if(!name) return;
  cat.title=name.trim()||cat.title;
  saveBoard(); 
  render();
}

/* ×¤×¨×™×˜ */
function renderItem(item,catId){
  const el=document.createElement("div"); 
  el.className="item"; 
  el.draggable=true;
  el.dataset.itemId=item.id; 
  el.dataset.catId=catId;

  const pr=item.priority||"green";
  const badge=document.createElement("span"); 
  badge.className="badge "+pr;
  badge.innerHTML=`<span class="dot ${pr}"></span>${priorityLabel(pr)}`;

  const title=document.createElement("div"); 
  title.className="grow";
  title.innerHTML=`<div><strong>${escapeHTML(item.title)}</strong></div><div class="meta">${item.due?"×ª××¨×™×š ×™×¢×“: "+item.due:"×œ×œ× ×ª××¨×™×š ×™×¢×“"}</div>`;

  const actions=document.createElement("div"); 
  actions.className="actions";
  const editBtn=document.createElement("button"); 
  editBtn.className="btn-ghost"; 
  editBtn.textContent="âœï¸"; 
  editBtn.title="×¢×¨×™×›×”";
  editBtn.addEventListener("click",()=>openEditModal(catId,item.id));
  const delBtn=document.createElement("button"); 
  delBtn.className="btn-ghost"; 
  delBtn.textContent="ğŸ—‘ï¸"; 
  delBtn.title="××—×™×§×”";
  delBtn.addEventListener("click",()=>{
    if(confirm(`×œ××—×•×§ ××ª "${item.title}"?`)){
      board.categories.find(c=>c.id===catId).items=board.categories.find(c=>c.id===catId).items.filter(it=>it.id!==item.id);
      saveBoard();
      render();
    }
  });
  actions.append(editBtn,delBtn);

  el.append(badge,title,actions);

  const qm=document.createElement("div"); 
  qm.className="quick-move";
  qm.innerHTML='<div class="title">××¢×‘×¨ ××”×™×¨</div><div class="row"><select class="qm-select"></select><button class="btn">×”×¢×‘×¨×™</button></div>';
  el.appendChild(qm); 
  setupLongPress(el,qm,catId,item.id);
  return el;
}

/* ×”×•×¡×¤×”/×§×˜×’×•×¨×™×” */
document.getElementById("addVideoBtn").addEventListener("click",()=>{
  const t=prompt("×©× ×”×¡×¨×˜×•×Ÿ:");
  if(!t)return;
  const pr=prompt("×“×—×™×¤×•×ª (red/yellow/green)?","green");
  const d=prompt("×ª××¨×™×š ×™×¢×“ (YYYY-MM-DD):","");
  const cn=board.categories.map((c,i)=>`${i+1}. ${c.title}`).join("\n");
  let idx=parseInt(prompt("×œ××™×–×• ×§×˜×’×•×¨×™×”?\n"+cn,"1")||"1",10)-1;
  (board.categories[idx]||board.categories[0]).items.push({
    id:uid(),
    title:t.trim(),
    priority:normPriority(pr),
    due:d||""
  });
  saveBoard();
  render();
});

document.getElementById("addCategoryBtn").addEventListener("click",()=>{
  const n=prompt("×©× ×”×§×˜×’×•×¨×™×”:");
  if(n){
    board.categories.push({
      id:uid(),
      title:n.trim(),
      collapsed:false,
      items:[]
    });
    saveBoard();
    render();
  }
});

/* ××•×“××œ ×¢×¨×™×›×ª ×¤×¨×™×˜ */
const editModal=document.getElementById("editModal");
const closeEdit=document.getElementById("closeEdit");
const editTitleInput=document.getElementById("editTitleInput");
const editDueInput=document.getElementById("editDueInput");
const editCategorySelect=document.getElementById("editCategorySelect");
const saveItemBtn=document.getElementById("saveItemBtn");
const deleteItemBtn=document.getElementById("deleteItemBtn");
const chipButtons=()=>Array.from(document.querySelectorAll('.editor .chip'));

let editCtx={catId:null,itemId:null,pr:"green"};

function openEditModal(catId,itemId){
  editCtx={catId,itemId};
  const cat=board.categories.find(c=>c.id===catId);
  const item=cat.items.find(i=>i.id===itemId);
  editTitleInput.value=item.title||"";
  editDueInput.value=item.due||"";
  editCtx.pr=item.priority||"green";
  chipButtons().forEach(b=>b.classList.toggle('active',b.dataset.pr===editCtx.pr));
  editCategorySelect.innerHTML="";
  board.categories.forEach(c=>{
    const o=document.createElement("option");
    o.value=c.id;
    o.textContent=c.title;
    if(c.id===catId)o.selected=true;
    editCategorySelect.appendChild(o);
  });
  editModal.style.display="flex";
}

closeEdit.addEventListener("click",()=>editModal.style.display="none");

document.querySelectorAll('.editor .chip').forEach(b=>b.addEventListener("click",()=>{
  editCtx.pr=b.dataset.pr;
  chipButtons().forEach(x=>x.classList.toggle('active',x===b));
}));

saveItemBtn.addEventListener("click",()=>{
  const fromCat=board.categories.find(c=>c.id===editCtx.catId);
  const item=fromCat.items.find(i=>i.id===editCtx.itemId);
  const toCatId=editCategorySelect.value;
  item.title=editTitleInput.value.trim()||"×œ×œ× ×©×";
  item.due=editDueInput.value||"";
  item.priority=editCtx.pr;
  if(toCatId!==editCtx.catId){
    fromCat.items=fromCat.items.filter(i=>i.id!==item.id);
    board.categories.find(c=>c.id===toCatId).items.push(item);
  }
  saveBoard();
  editModal.style.display="none";
  render();
});

deleteItemBtn.addEventListener("click",()=>{
  if(confirm("×œ××—×•×§?")){
    board.categories.find(c=>c.id===editCtx.catId).items=board.categories.find(c=>c.id===editCtx.catId).items.filter(i=>i.id!==editCtx.itemId);
    saveBoard();
    editModal.style.display="none";
    render();
  }
});

/* ×¡×™× ×•×Ÿ ×§×•××¤×§×˜×™ */
const searchInput=document.getElementById("searchInput");
["keyup","change"].forEach(ev=>searchInput.addEventListener(ev,debounce(()=>render(),150)));
["filterRed","filterYellow","filterGreen"].forEach(id=>document.getElementById(id).addEventListener("change",()=>render()));

function currentFilters(){
  return{
    q:(searchInput.value||"").toLowerCase().trim(),
    red:document.getElementById("filterRed").checked,
    yellow:document.getElementById("filterYellow").checked,
    green:document.getElementById("filterGreen").checked
  };
}

function passesFilters(item,f){
  const byText=!f.q||item.title.toLowerCase().includes(f.q);
  const anyColor=f.red||f.yellow||f.green;
  const byColor=!anyColor||(item.priority==="red"&&f.red)||(item.priority==="yellow"&&f.yellow)||(item.priority==="green"&&f.green);
  return byText&&byColor;
}

const toggleFiltersBtn=document.getElementById("toggleFilters");
const filtersPanel=document.getElementById("filtersPanel");

toggleFiltersBtn.addEventListener("click",()=>{
  filtersPanel.classList.toggle("open");
  toggleFiltersBtn.textContent=filtersPanel.classList.contains("open")?"××¡× × ×™× â–´":"××¡× × ×™× â–¾";
});

/* ×¤×ª×—/×¡×’×•×¨ ×”×›×œ â€“ ×›×¤×ª×•×¨ ××—×“ */
toggleAllBtn.addEventListener("click",()=>{
  const anyCollapsed=board.categories.some(c=>c.collapsed);
  board.categories.forEach(c=>c.collapsed=!anyCollapsed);
  saveBoard();
  render();
});

function updateToggleAllLabel(){
  toggleAllBtn.textContent=board.categories.some(c=>c.collapsed)?"×¤×ª×— ×”×›×•×œ":"×¡×’×•×¨ ×”×›×•×œ";
}

/* DnD */
let dragState={itemId:null,fromCat:null,hoverTimer:null,draggedEl:null};

function attachDnD(){
  document.querySelectorAll(".item").forEach(el=>{
    el.addEventListener("dragstart",e=>{
      el.classList.add("dragging");
      dragState={itemId:el.dataset.itemId,fromCat:el.dataset.catId,draggedEl:el};
      e.dataTransfer.effectAllowed="move";
      e.dataTransfer.setData('text/plain', el.dataset.itemId);
      hideAnyQuickMove();
    });
    el.addEventListener("dragend",()=>{
      el.classList.remove("dragging");
      document.querySelectorAll(".item").forEach(i=>i.classList.remove("drag-over-top","drag-over-bottom"));
      dragState={};
      document.querySelectorAll(".col,.col-header").forEach(x=>x.classList.remove("dragover","drop-hover"));
    });
    el.addEventListener("dragover",e=>{
      e.preventDefault();
      if(!dragState.draggedEl||dragState.draggedEl===el||el.dataset.catId!==dragState.fromCat)return;
      const rect=el.getBoundingClientRect();
      const midY=rect.top+rect.height/2;
      document.querySelectorAll(".item").forEach(i=>i.classList.remove("drag-over-top","drag-over-bottom"));
      el.classList.add(e.clientY<midY?"drag-over-top":"drag-over-bottom");
    });
    el.addEventListener("dragleave",()=>el.classList.remove("drag-over-top","drag-over-bottom"));
    el.addEventListener("drop",e=>{
      e.preventDefault();
      e.stopPropagation();
      el.classList.remove("drag-over-top","drag-over-bottom");
      if(el.dataset.catId===dragState.fromCat){
        const rect=el.getBoundingClientRect();
        reorderItemInCategory(dragState.fromCat,dragState.itemId,el.dataset.itemId,e.clientY<rect.top+rect.height/2);
      }
    });
  });
  
  document.querySelectorAll(".col").forEach(col=>{
    const list=col.querySelector(".list");
    list.addEventListener("dragover",e=>{
      e.preventDefault();
      col.classList.add("dragover");
    });
    list.addEventListener("dragleave",()=>col.classList.remove("dragover"));
    list.addEventListener("drop",e=>{
      e.preventDefault();
      col.classList.remove("dragover");
      if(col.dataset.catId!==dragState.fromCat)moveItem(dragState.fromCat,col.dataset.catId,dragState.itemId);
    });
  });
}

function reorderItemInCategory(catId,draggedItemId,targetItemId,insertBefore){
  const cat=board.categories.find(c=>c.id===catId);
  if(!cat)return;
  const dIdx=cat.items.findIndex(i=>i.id===draggedItemId);
  const tIdx=cat.items.findIndex(i=>i.id===targetItemId);
  if(dIdx===-1||tIdx===-1||dIdx===tIdx)return;
  const[item]=cat.items.splice(dIdx,1);
  cat.items.splice(insertBefore?cat.items.findIndex(i=>i.id===targetItemId):cat.items.findIndex(i=>i.id===targetItemId)+1,0,item);
  saveBoard();
  render();
}

function setupHeaderDrop(header,cat){
  header.addEventListener("dragover",e=>{
    e.preventDefault();
    header.classList.add("drop-hover");
    if(cat.collapsed&&!dragState.hoverTimer)dragState.hoverTimer=setTimeout(()=>{
      cat.collapsed=false;
      saveBoard();
      render();
    },500);
  });
  header.addEventListener("dragleave",()=>{
    header.classList.remove("drop-hover");
    clearTimeout(dragState.hoverTimer);
    dragState.hoverTimer=null;
  });
  header.addEventListener("drop",e=>{
    e.preventDefault();
    header.classList.remove("drop-hover");
    clearTimeout(dragState.hoverTimer);
    dragState.hoverTimer=null;
    moveItem(dragState.fromCat,cat.id,dragState.itemId);
  });
}

function moveItem(fromCatId,toCatId,itemId){
  if(!fromCatId||!toCatId||!itemId||fromCatId===toCatId)return;
  const from=board.categories.find(c=>c.id===fromCatId);
  const to=board.categories.find(c=>c.id===toCatId);
  if(!from||!to)return;
  const idx=from.items.findIndex(i=>i.id===itemId);
  if(idx===-1)return;
  to.items.push(from.items.splice(idx,1)[0]);
  saveBoard();
  render();
}

/* ×™×™×‘×•×/×™×™×¦×•× */
const importModal=document.getElementById("importModal");

document.getElementById("importBtn").addEventListener("click",()=>importModal.style.display="flex");
document.getElementById("closeImport").addEventListener("click",()=>importModal.style.display="none");

document.getElementById("applyImport").addEventListener("click",()=>{
  const txt=document.getElementById("importTextarea").value.trim();
  if(!txt)return alert("×œ× ×”×•×–×Ÿ ×ª×•×›×Ÿ");
  try{
    const p=JSON.parse(txt);
    if(Array.isArray(p.categories)){
      p.categories.forEach(cat=>{
        cat.id=cat.id||uid();
        cat.collapsed=!!cat.collapsed;
        cat.items=(cat.items||[]).map(it=>({
          id:it.id||uid(),
          title:it.title||"",
          priority:normPriority(it.priority),
          due:it.due||""
        }));
      });
      board=p;
      if(!board.tasks)board.tasks=[];
    }else{
      board={
        tasks:[],
        categories:Object.keys(p).map(name=>({
          id:uid(),
          title:name,
          collapsed:false,
          items:(p[name]||[]).map(it=>({
            id:uid(),
            title:it.title||"",
            priority:normPriority(it.priority),
            due:it.due||""
          }))
        }))
      };
    }
    saveBoard();
    importModal.style.display="none";
    render();
  }catch(e){
    alert("JSON ×œ× ×ª×§×™×Ÿ");
  }
});

document.getElementById("exportBtn").addEventListener("click",()=>{
  const d=JSON.stringify(board,null,2);
  try{
    navigator.clipboard.writeText(d);
    alert("×”×•×¢×ª×§ ×œ×œ×•×—");
  }catch{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(new Blob([d],{type:"application/json"}));
    a.download="video-board.json";
    a.click();
  }
});

/* ×œ×—×™×¦×” ××¨×•×›×” â€“ ××¢×‘×¨ ××”×™×¨ */
function setupLongPress(el,qm,catId,itemId){
  let timer=null;
  let startX=0,startY=0;
  const start=(e)=>{
    const p=e.touches?e.touches[0]:e;
    startX=p.clientX;
    startY=p.clientY;
    timer=setTimeout(()=>{
      const sel=qm.querySelector(".qm-select");
      sel.innerHTML="";
      board.categories.forEach(c=>{
        const o=document.createElement("option");
        o.value=c.id;
        o.textContent=c.title;
        if(c.id===catId)o.selected=true;
        sel.appendChild(o);
      });
      qm.style.display="block";
      qm.style.top=el.offsetTop+6+"px";
      qm.style.insetInlineStart=(el.offsetWidth-qm.offsetWidth-6)+"px";
      const btn=qm.querySelector("button");
      btn.onclick=()=>{
        const toCatId=sel.value;
        qm.style.display="none";
        moveItem(catId,toCatId,itemId);
      };
      const outsideClose=(ev)=>{
        if(!qm.contains(ev.target))qm.style.display="none";
      };
      setTimeout(()=>{
        document.addEventListener("mousedown",outsideClose,{once:true});
        document.addEventListener("touchstart",outsideClose,{once:true,passive:true});
      },0);
    },700);
  };
  const cancel=()=>{
    clearTimeout(timer);
    timer=null;
  };
  el.addEventListener("mousedown",start);
  el.addEventListener("mouseup",cancel);
  el.addEventListener("mouseleave",cancel);
  el.addEventListener("touchstart",start,{passive:true});
  el.addEventListener("touchend",cancel);
  el.addEventListener("touchmove",(e)=>{
    const t=e.touches[0];
    if(Math.hypot(t.clientX-startX,t.clientY-startY)>12)cancel();
  },{passive:true});
}

function hideAnyQuickMove(){
  document.querySelectorAll(".quick-move").forEach(q=>q.style.display="none");
}

/* ××“ ×”×ª×§×“××•×ª */
function renderProgress(){
  const excludeTitle="×¢×œ×”";
  const doneTitle="××•×›×Ÿ ×œ×¢×œ×™×™×”";
  let total=0, done=0, red=0, yellow=0, green=0;
  
  board.categories.forEach(c=>{
    if(c.title===excludeTitle) return;
    if(c.title===doneTitle){ 
      done+=c.items.length; 
      total+=c.items.length; 
    }else{
      total+=c.items.length;
      c.items.forEach(it=>{
        if(it.priority==="red") red++;
        else if(it.priority==="yellow") yellow++;
        else green++;
      });
    }
  });
  
  const barInner=document.getElementById("barInner");
  const legend=document.getElementById("progressLegend");
  const nums=document.getElementById("progressNumbers");
  const pct=(n)=> total? Math.max(0,Math.min(100,(n/total)*100)) : 0;

  barInner.innerHTML="";
  const segDone=document.createElement("div"); 
  segDone.className="seg done"; 
  segDone.style.width=pct(done)+"%";
  const segRed=document.createElement("div"); 
  segRed.className="seg red"; 
  segRed.style.width=pct(red)+"%";
  const segY=document.createElement("div"); 
  segY.className="seg yellow"; 
  segY.style.width=pct(yellow)+"%";
  const segG=document.createElement("div"); 
  segG.className="seg green"; 
  segG.style.width=pct(green)+"%";
  barInner.append(segDone,segRed,segY,segG);

  nums.textContent = total ? `×”×•×©×œ××• ${done}/${total} (${Math.round(pct(done))}%)` : "××™×Ÿ ××©×™××•×ª ×œ×”×¦×’×”";
  legend.innerHTML = `
    <span>âœ… ××•×›×Ÿ ×œ×¢×œ×™×™×”: ${done}</span>
    <span>â€¢</span>
    <span><span class="dot red"></span> ×“×—×•×£: ${red}</span>
    <span><span class="dot yellow"></span> ×‘×™× ×™×™×: ${yellow}</span>
    <span><span class="dot green"></span> ×™×© ×–××Ÿ: ${green}</span>
  `;
}

/* ××ª×—×•×œ */
render();
</script>

</body>
</html>
